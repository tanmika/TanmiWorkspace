# TanmiWorkspace 架构与交互指南

## 1. 系统简介

**一句话定位**：TanmiWorkspace 是一个面向 AI 编程助手的分形任务跟踪系统。

**解决什么问题**：
- AI 在处理复杂任务时容易丢失上下文、遗漏步骤
- 长对话中难以追溯决策过程和执行历史
- 任务中断后难以恢复进度

**核心价值**：
- 结构化管理任务，支持无限层级分解
- 自动聚焦当前任务上下文，过滤无关信息
- 完整记录执行过程，支持回溯和恢复

---

## 2. 架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                         用户                                 │
│                    (提出需求、确认计划)                        │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                      AI 助手                                 │
│              (理解需求、调用工具、执行任务)                     │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                  TanmiWorkspace (MCP Server)                │
│    ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│    │ 工作区   │  │  节点    │  │  上下文  │  │   日志   │  │
│    │ 管理     │  │  管理    │  │  聚焦    │  │   记录   │  │
│    └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                    Hook 系统 (可选)                          │
│              (自动注入上下文、智能提醒)                        │
└─────────────────────────────────────────────────────────────┘
```

**三方角色**：

| 角色 | 职责 |
|------|------|
| 用户 | 提出需求、确认计划、验收结果 |
| AI 助手 | 理解需求、规划任务、调用 MCP 工具执行 |
| MCP Server | 存储状态、管理节点、提供上下文 |

---

## 3. 核心概念速查

### 基本概念

| 概念 | 说明 |
|------|------|
| **工作区 (Workspace)** | 一个独立任务的容器，包含目标、规则、文档引用 |
| **节点 (Node)** | 任务单元，可嵌套形成树形结构 |
| **规则 (Rules)** | 工作区级别的约束，所有节点都要遵守 |
| **文档引用 (Docs)** | 关联的参考文档路径和描述 |
| **会话绑定 (Session)** | 将当前对话与工作区关联，启用 Hook 自动注入 |

### 节点类型

| 类型 | 说明 | 可有子节点 | 典型用途 |
|------|------|:----------:|----------|
| `planning` | 规划节点 | ✅ | 分析、分解、派发任务 |
| `execution` | 执行节点 | ❌ | 具体执行任务、产出结果 |

### 节点状态

```
规划节点状态流转：
  pending → planning → monitoring → completed
                ↓           ↓
            cancelled    cancelled

执行节点状态流转：
  pending → implementing → validating → completed
                ↓              ↓
             failed ←──────────┘
                ↓
          (retry) implementing
```

**状态说明**：

| 状态 | 含义 |
|------|------|
| `pending` | 待开始 |
| `planning` | 规划中（分析、创建子节点） |
| `monitoring` | 监控中（等待子节点完成） |
| `implementing` | 执行中 |
| `validating` | 验证中 |
| `completed` | 已完成 |
| `failed` | 失败（可重试） |
| `cancelled` | 已取消 |

---

## 4. 交互模型

### 数据流向

```
用户提出需求
     ↓
AI 理解需求，调用 MCP 工具
     ↓
┌─────────────────────────────────────┐
│  workspace_init / node_create /     │
│  node_transition / log_append ...   │
└─────────────────────────────────────┘
     ↓
MCP Server 更新状态，返回结果 + hint
     ↓
AI 根据 hint 决定下一步
     ↓
向用户反馈进展或请求确认
```

### Hook 注入流程（启用 Hook 时）

```
会话开始 / 用户发送消息
     ↓
Hook 检测到绑定的工作区
     ↓
自动调用 context_get 获取上下文
     ↓
将上下文注入到 AI 的 system prompt
     ↓
AI 带着完整上下文理解用户请求
```

### 上下文传递机制

`context_get` 返回的内容包括：

| 内容 | 说明 |
|------|------|
| 工作区信息 | 目标、规则、活跃文档 |
| 祖先链 | 从根节点到当前节点的路径 |
| 子节点结论 | 已完成子节点的结论（冒泡） |
| 跨节点引用 | 显式引用的其他节点 |
| 日志历史 | 当前节点的操作记录 |

### 规则验证机制

```
AI 创建节点时传入 rulesHash
     ↓
Server 校验 hash 是否匹配当前规则
     ↓
┌─────────────┐    ┌─────────────┐
│  匹配成功   │    │  匹配失败   │
│  正常创建   │    │  返回错误   │
└─────────────┘    │  提示重新   │
                   │  获取规则   │
                   └─────────────┘
```

这确保 AI 在创建节点前已阅读最新规则。

---

## 5. 完整工作流程

### 阶段一：初始化

```
workspace_init(name, goal)
     ↓
返回 workspaceId + rootNodeId
     ↓
session_bind(sessionId, workspaceId)  // 可选，启用 Hook
```

### 阶段二：信息收集（强制前置）

**为什么必须**：确保 AI 在开始任务前充分了解项目情况。

```
node_create(type="execution", role="info_collection")
     ↓
node_transition(action="start")
     ↓
收集项目信息、分析需求
     ↓
node_transition(action="complete", conclusion="...")
     ↓
conclusion 中的规则和文档自动归档到工作区
```

**结论格式**（自动归档）：
```markdown
## 规则
- 规则1
- 规则2

## 文档
- /path/to/doc1: 文档描述1
- /path/to/doc2: 文档描述2
```

### 阶段三：任务规划

```
根节点进入 planning 状态
     ↓
分析任务，决定是否需要分解
     ↓
┌─────────────────┐    ┌─────────────────┐
│   简单任务      │    │   复杂任务       │
│ 直接创建执行节点 │    │ 创建子规划节点   │
└─────────────────┘    │ 或多个执行节点   │
                       └─────────────────┘
     ↓
向用户确认计划后再执行
```

### 阶段四：任务执行

```
node_transition(action="start")  // pending → implementing
     ↓
执行具体任务
     ↓
log_append(event="...")  // 记录关键步骤
     ↓
遇到问题？
┌─────────────────┐    ┌─────────────────┐
│      是         │    │      否         │
│ problem_update  │    │    继续执行      │
└─────────────────┘    └─────────────────┘
     ↓
完成任务
     ↓
node_transition(action="complete", conclusion="...")
```

### 阶段五：汇总完成

```
所有子节点完成
     ↓
父节点收到提醒（通过 hint 或 Hook）
     ↓
汇总子节点结论
     ↓
node_transition(action="complete", conclusion="...")
     ↓
根节点完成 = 整个任务结束
```

### 完整流程图

```
┌──────────────────────────────────────────────────────────┐
│                    workspace_init                        │
└────────────────────────┬─────────────────────────────────┘
                         ↓
┌──────────────────────────────────────────────────────────┐
│           info_collection (强制)                         │
│     收集信息 → 归档规则和文档 → complete                  │
└────────────────────────┬─────────────────────────────────┘
                         ↓
┌──────────────────────────────────────────────────────────┐
│              root node: start                            │
│                 进入 planning                            │
└────────────────────────┬─────────────────────────────────┘
                         ↓
         ┌───────────────┴───────────────┐
         ↓                               ↓
┌─────────────────┐            ┌─────────────────┐
│  创建执行节点    │            │  创建规划子节点  │
│  直接执行任务    │            │  继续分解任务    │
└────────┬────────┘            └────────┬────────┘
         ↓                               ↓
┌─────────────────┐            ┌─────────────────┐
│    complete     │            │   递归执行...    │
└────────┬────────┘            └────────┬────────┘
         └───────────────┬───────────────┘
                         ↓
┌──────────────────────────────────────────────────────────┐
│              root node: complete                         │
│                 汇总结论，任务完成                         │
└──────────────────────────────────────────────────────────┘
```

---

## 6. 典型交互场景

### 场景 1：简单任务

**情况**：任务明确，无需分解

```
用户: "给 README 添加安装说明"

AI 操作序列:
1. workspace_init(name="添加安装说明", goal="...")
2. node_create(role="info_collection") → start → complete
3. node_create(type="execution", title="编写安装说明")
4. node_transition(action="start")
5. 编辑 README 文件
6. node_transition(action="complete", conclusion="已添加安装说明")
7. 根节点 complete，任务结束
```

### 场景 2：复杂任务

**情况**：需要分解为多个子任务

```
用户: "实现用户登录功能"

AI 操作序列:
1. workspace_init → info_collection → 分析需求
2. 根节点 start，进入 planning
3. 创建子节点：
   - "设计数据库表结构" (execution)
   - "实现后端 API" (execution)
   - "实现前端页面" (execution)
4. 向用户确认计划
5. 依次执行各子节点
6. 汇总完成
```

### 场景 3：执行中遇阻

**情况**：执行过程中发现问题无法继续

```
AI 执行 "实现后端 API" 时发现缺少依赖

操作序列:
1. problem_update(problem="缺少 JWT 库")
2. 尝试解决...
3. 如果解决: problem_clear() → 继续
4. 如果无法解决: node_transition(action="fail", conclusion="缺少依赖")
5. 父节点重新规划，可能创建新节点处理依赖问题
```

### 场景 4：任务追加需求

**情况**：任务完成后用户提出新需求

```
用户: "再加一个记住密码功能"

操作序列:
1. node_transition(nodeId="root", action="reopen")
2. 创建新的执行节点
3. 执行新需求
4. 重新汇总完成
```

### 场景 5：会话中断恢复

**情况**：对话中断后继续之前的任务

```
新会话开始

操作序列:
1. session_status() → 查看之前绑定的工作区
2. session_bind(workspaceId="之前的工作区")
3. context_get() → 获取当前状态
4. 根据状态继续执行未完成的节点
```

---

## 7. Hook 与智能提醒

### Hook 触发时机

| 事件 | Claude Code | Cursor |
|------|-------------|--------|
| 会话开始 | SessionStart | - |
| 用户发送消息 | UserPromptSubmit | beforeSubmitPrompt |

### 注入内容

Hook 会自动注入：
- 当前聚焦节点的上下文
- 工作区规则
- 智能提醒（如有）

### 智能提醒优先级

| 优先级 | 类型 | 触发条件 |
|:------:|------|----------|
| P0 | 问题提醒 | 节点有未解决的问题 |
| P1 | 日志超时 | 执行中 + 最后日志 > 3 分钟 |
| P2 | 子节点完成 | 监控中 + 所有子节点已完成 |
| P3 | 计划确认 | 规划中 + 有子节点待确认 |
| P4 | 无日志 | 执行中 + 无日志 > 1 分钟 |
| P5 | 问题记录 | 执行中 + 无问题记录 > 5 分钟 |
| P6 | 失败引导 | 执行节点 + failed 状态 |
| P7 | 文档缺失 | 执行中 + 无文档引用 > 1 分钟 |

提醒采用节流机制（3 分钟间隔），P0 不受节流限制。

---

## 8. API 工具速查

### 工作区管理

| 工具 | 用途 |
|------|------|
| `workspace_init` | 创建新工作区 |
| `workspace_get` | 获取工作区详情 |
| `workspace_list` | 列出所有工作区 |
| `workspace_delete` | 删除工作区 |
| `workspace_update_rules` | 更新工作区规则 |

### 节点管理

| 工具 | 用途 |
|------|------|
| `node_create` | 创建子节点 |
| `node_get` | 获取节点详情 |
| `node_list` | 获取节点树 |
| `node_update` | 更新节点信息 |
| `node_delete` | 删除节点 |
| `node_transition` | 状态转换（start/complete/fail...） |
| `node_move` | 移动节点到新父节点 |

### 上下文管理

| 工具 | 用途 |
|------|------|
| `context_get` | 获取节点聚焦上下文 |
| `context_focus` | 切换聚焦节点 |
| `node_isolate` | 设置节点隔离状态 |
| `node_reference` | 管理文档/节点引用 |

### 日志与问题

| 工具 | 用途 |
|------|------|
| `log_append` | 追加日志记录 |
| `problem_update` | 更新当前问题 |
| `problem_clear` | 清空问题 |

### 会话管理

| 工具 | 用途 |
|------|------|
| `session_bind` | 绑定会话到工作区 |
| `session_unbind` | 解除绑定 |
| `session_status` | 查询绑定状态 |

### 帮助系统

| 工具 | 用途 |
|------|------|
| `tanmi_help` | 获取使用指南 |
| `tanmi_prompt` | 获取话术模板 |

> 详细参数和返回值请参考 [API 参考文档](api-reference.md)

---

## 9. 常见问题

### 什么时候适合用 TanmiWorkspace？

| 适合 | 不适合 |
|------|--------|
| 复杂的多步骤任务 | 简单的一次性问答 |
| 需要长期跟踪的项目 | 快速的代码片段生成 |
| 多人协作或交接的任务 | 临时的调试和探索 |
| 需要回溯决策过程的工作 | 不需要记录的日常操作 |

### 我需要做什么？

作为用户，你只需要：

1. **提出需求** - 告诉 AI 你想做什么
2. **确认计划** - AI 会展示任务分解方案，你确认后才会执行
3. **回答问题** - AI 遇到不确定的地方会询问你
4. **验收结果** - 检查 AI 的产出是否符合预期

所有的工作区创建、节点管理、状态跟踪都由 AI 自动完成。

### 怎么查看任务进度？

- **对话中询问** - 直接问 AI "当前进度如何"
- **Web 界面** - 访问 Web UI 查看可视化进度，web url可以通过对ai提出请求获取
- **工作区状态** - AI 会在关键节点主动汇报进展

### 任务数据存在哪里？

工作区数据存储在项目目录下的 `.tanmi-workspace` 文件夹中：

```
.tanmi-workspace/
├── ws-xxx/              # 工作区目录
│   ├── Workspace.md     # 工作区元数据
│   └── nodes/           # 节点数据
└── ...
```

数据以 Markdown 格式存储，可读性强，也方便版本控制。

### 对话中断了怎么办？

不用担心，所有进度都已保存。新对话开始时：
- 如果安装了 Hook，当会话id不变时，会自动恢复上下文
- 如果没有 Hook，告诉 AI "继续之前的任务" 即可

### 可以同时进行多个任务吗？

可以。每个任务对应一个独立的工作区，互不干扰。你可以：
- 在一个对话中切换不同工作区，或者参考别的工作区内容
- 或在多个对话窗口中分别处理不同任务

---

## 进阶阅读

- [API 参考文档](api-reference.md) - 详细的工具参数和返回值
- [数据模型](data-models.md) - 数据结构定义和状态机规则
- [配置方式](../配置方式.md) - 安装和配置指南
- [README](../README.md) - 项目概述和快速开始
