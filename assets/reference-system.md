# 引用系统设计

本文档定义 TanmiWorkspace 的文档引用和规则系统设计规范。

## 概述

引用系统分为两类：**文档 (docs)** 和 **规则 (rules)**，它们有不同的性质和用途。

| 类型 | 文档 (docs) | 规则 (rules) |
|------|-------------|--------------|
| 性质 | 可读写、动态变化 | 只读、全局固定 |
| 内容 | md 文档、重要代码文件 | md 规则文件、对话中补充的临时规则 |
| 存储位置 | 工作区（全局索引）+ 节点（当前需要） | 仅工作区 |
| 生命周期 | 可添加、可过期 | 创建时设定，不变 |

## 工作流程

### 1. 任务启动时

```
扫描项目根目录一级菜单
    ↓
分析结构（文档文件夹？README？代码结构？）
    ↓
记录项目大致结构到日志
    ↓
根据任务需要：
  - 有相关文档 → 记录到工作区全局索引
  - 无相关文档 → 向用户索取或标记缺失
```

### 2. 文档生命周期

- **添加时机**：
  - 任务开始时的初始分析
  - 需求变化时发现新的相关文档
  - 实现过程中发现需要参考的代码文件

- **过期时机**：
  - 任务完成后主动评估
  - 文档不再与当前工作相关时
  - 通过 `node_reference(action="expire")` 手动过期

- **状态**：
  - `active`：当前有效，会出现在上下文中
  - `expired`：已过期，保留历史记录但不出现在上下文中

### 3. 存储层级

#### 工作区级别（全局索引）

`Workspace.md` 中的 `## 文档` 节：
- 记录整个工作台使用过的**所有**文档（除被删除的）
- 作为文档查找的第一优先级
- 新发现的文档先存入这里

#### 节点级别（当前需要）

`Info.md` 中的 `## 文档引用` 节：
- 只记录该节点工作**当前需要**的文档
- 不自动继承父节点文档
- 由父节点在创建/派发子节点时显式指定

### 4. 文档查找优先级

当节点需要文档时：

```
1. 先查工作区全局索引（Workspace.md ## 文档）
    ↓ 找到 → 直接引用
    ↓ 未找到
2. 搜索项目文件系统
    ↓ 找到 → 存入工作区索引 + 引用到节点
    ↓ 未找到
3. 向用户索取或标记为缺失
```

## 节点与文档的关系

### 核心原则：显式派发，不自动继承

```
父节点 (docs: [A, B, C])
    │
    │ node_create(docs: [A, B])  ← 显式指定派发哪些
    ↓
子节点 (docs: [A, B])  ← 只有被派发的文档
    │
    │ 执行过程中发现信息不足
    ↓
子节点标记失败 → 返回父节点 → 补充信息/文档 → 重新派发
```

### 为什么不自动继承？

1. **上下文精简**：子节点只需要与自己任务相关的文档
2. **显式依赖**：明确每个任务依赖什么信息
3. **失败可追溯**：信息不足时能清晰识别缺了什么

## 规则系统

### 存储位置

规则**只存储在工作区级别**（`Workspace.md ## 规则`），节点不存储规则。

### 节点的"规则"

如果某个节点有特定的约束条件，应该写入该节点的 **需求 (requirement)** 中，而不是作为规则。

```markdown
## 需求

实现用户认证功能。

约束：
- 必须使用 JWT
- 不能使用第三方认证服务
```

### 规则内容

- 项目级别的 md 规则文件
- 对话中用户补充的临时规则
- 编码规范、架构约束等

## API 变更

### node_create

新增 `docs` 参数，用于父节点向子节点派发文档：

```typescript
interface NodeCreateParams {
  workspaceId: string;
  parentId: string;
  title: string;
  requirement: string;
  docs?: DocRef[];  // 新增：派发给子节点的文档
}
```

### node_split

同样新增 `docs` 参数：

```typescript
interface NodeSplitParams {
  workspaceId: string;
  parentId: string;
  title: string;
  requirement: string;
  inheritContext?: boolean;
  docs?: DocRef[];  // 新增：派发给子节点的文档
}
```

## 最佳实践

1. **任务开始时**：先扫描项目结构，记录相关文档到工作区
2. **创建子节点时**：评估子任务需要哪些文档，显式派发
3. **任务完成时**：评估文档是否还需要，过期不再需要的
4. **信息不足时**：子节点应该失败并说明缺少什么，由父节点补充后重试
5. **规则 vs 需求**：全局约束放规则，节点约束放需求
