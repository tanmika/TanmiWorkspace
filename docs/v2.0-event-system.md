# TanmiWorkspace 2.0 统一事件机制设计

## 背景与问题

当前 Hook 系统存在平台碎片化问题：

- 各平台 Hook 时机不同（Claude Code 有 SessionStart，Cursor 没有）
- 注册方式不同（hooks.json vs cursor rules）
- 启用状态管理分散
- 无 Hook 平台无法获得上下文注入能力

导致的问题：
- 适配逻辑分散在多个入口脚本中
- 新平台适配需要大量重复代码
- 难以统一管理和扩展功能

## 设计目标

1. **调用与结果分离**：事件收集层只负责上报，决策引擎统一处理
2. **平台无关决策**：根据配置自动判断"是否响应"及"响应内容"
3. **Hook 优先级保障**：有 Hook 的平台保持最佳体验，无 Hook 平台通过 MCP 主动调用达到 70-80% 效果
4. **用户自定义规则**：支持工作区级、项目级、全局级的自定义决策规则

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         事件源（触发层）                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐    │
│  │ CC Hook  │  │ Cursor   │  │ MCP 调用 │  │ 未来新平台   │    │
│  │SessionSt │  │beforeSub │  │(无Hook)  │  │    ...       │    │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └──────┬───────┘    │
│       │             │             │               │            │
│       └─────────────┴──────┬──────┴───────────────┘            │
│                            ▼                                    │
│              ┌─────────────────────────────┐                   │
│              │      统一事件格式            │                   │
│              └─────────────┬───────────────┘                   │
└────────────────────────────┼───────────────────────────────────┘
                             ▼
┌────────────────────────────────────────────────────────────────┐
│                      决策引擎（核心服务）                        │
│  ┌────────────────────────────────────────────────────────┐   │
│  │                    状态管理器                           │   │
│  │  - 会话绑定状态                                         │   │
│  │  - 节点执行状态                                         │   │
│  │  - 最近提醒记录（节流用）                               │   │
│  └────────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────────┐   │
│  │                    平台配置                             │   │
│  │  - Hook 是否启用                                        │   │
│  │  - 哪些事件已被 Hook 覆盖                               │   │
│  │  - 平台特性（支持 agent_message？）                     │   │
│  └────────────────────────────────────────────────────────┘   │
│  ┌────────────────────────────────────────────────────────┐   │
│  │                    规则引擎                             │   │
│  │  - 内置规则                                             │   │
│  │  - 用户自定义规则                                       │   │
│  │  - 规则优先级与节流                                     │   │
│  └────────────────────────────────────────────────────────┘   │
└────────────────────────────┬───────────────────────────────────┘
                             ▼
┌────────────────────────────────────────────────────────────────┐
│                      响应分发（输出层）                         │
│  根据 source + platform 格式化输出                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ CC Hook 格式 │  │ Cursor 格式  │  │ MCP 返回值   │         │
│  │{hookSpecific │  │{continue,    │  │{content:[...│         │
│  │ Output:...}  │  │ agent_msg}   │  │ ]}           │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└────────────────────────────────────────────────────────────────┘
```

## 核心数据结构

### 统一事件格式

```typescript
interface TanmiEvent {
  // 来源信息
  source: 'hook' | 'mcp' | 'api';
  platform: 'claude-code' | 'cursor' | 'web' | 'api';

  // 事件信息
  event: 'session_start' | 'prompt_submit' | 'task_complete' | 'status_check';
  sessionId: string;

  // 载荷
  payload: {
    prompt?: string;      // 用户输入
    nodeId?: string;      // 当前节点
    // ...
  };
}
```

### 决策结果

```typescript
interface DecisionResult {
  shouldRespond: boolean;

  // 要执行的动作列表
  actions: Array<{
    type: 'inject_context' | 'smart_reminder' | 'binding_hint';
    content: string;
    priority: number;
  }>;

  // 节流/去重信息
  throttle?: {
    key: string;
    ttl: number;
  };
}
```

### 平台配置

```typescript
interface PlatformConfig {
  platform: string;

  // Hook 配置
  hooks: {
    enabled: boolean;
    events: string[];  // Hook 覆盖的事件列表
  };

  // 输出能力
  capabilities: {
    agentMessage: boolean;   // 能否注入 AI 看到的消息
    userMessage: boolean;    // 能否注入用户看到的消息
    systemPrompt: boolean;   // 能否修改 system prompt
  };

  // 输出格式器
  formatter: (actions: Action[]) => any;
}
```

## 规则系统

### 规则接口

```typescript
interface DecisionRule {
  id: string;
  name: string;

  // 匹配条件
  match: {
    events?: string[];           // 匹配哪些事件
    platforms?: string[];        // 匹配哪些平台
    condition?: (ctx: RuleContext) => boolean;  // 自定义条件
  };

  // 优先级（数字越小越优先）
  priority: number;

  // 执行逻辑
  execute: (ctx: RuleContext) => Action | null;
}

interface RuleContext {
  event: TanmiEvent;
  state: SessionState;
  config: PlatformConfig;
  workspace?: WorkspaceData;
  node?: NodeData;
}
```

### 内置规则示例

```typescript
const builtinRules: DecisionRule[] = [
  {
    id: 'context-inject',
    name: '工作区上下文注入',
    match: { events: ['session_start'] },
    priority: 10,
    execute: (ctx) => ctx.state.bound
      ? { type: 'inject_context', content: buildContext(ctx) }
      : null
  },
  {
    id: 'smart-reminder',
    name: '智能提醒',
    match: { events: ['prompt_submit'] },
    priority: 20,
    execute: (ctx) => analyzeAndRemind(ctx)
  },
  {
    id: 'plan-confirm',
    name: '计划确认提醒',
    match: { events: ['prompt_submit'] },
    priority: 15,
    execute: (ctx) => {
      if (ctx.node?.status === 'planning' && ctx.node?.children?.length > 0) {
        return { type: 'reminder', content: '请向用户展示计划并等待确认' };
      }
      return null;
    }
  }
];
```

### 用户自定义规则

用户可在 `.tanmi/rules.json` 或工作区配置中定义规则：

```json
{
  "customRules": [
    {
      "id": "user/require-test",
      "name": "强制测试提醒",
      "match": {
        "events": ["task_complete"],
        "condition": "node.title.includes('实现') && !node.conclusion.includes('测试')"
      },
      "priority": 5,
      "action": {
        "type": "reminder",
        "content": "请确保已运行测试后再标记完成"
      }
    },
    {
      "id": "user/doc-update",
      "name": "文档更新提醒",
      "match": {
        "events": ["task_complete"],
        "condition": "workspace.rules.includes('文档同步更新')"
      },
      "priority": 8,
      "action": {
        "type": "reminder",
        "content": "根据工作区规则，请检查是否需要更新相关文档"
      }
    }
  ]
}
```

### 规则引擎流程

```
事件进入
    ↓
┌─────────────────────────────────────────────────┐
│  1. 收集所有匹配的规则                           │
│     - 内置规则 (builtin/)                        │
│     - 工作区规则 (workspace.customRules)         │
│     - 用户全局规则 (~/.tanmi/rules.json)         │
└─────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────┐
│  2. 按优先级排序                                 │
└─────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────┐
│  3. 依次执行，收集 Actions                       │
│     - 支持 stopPropagation（阻止后续规则）       │
│     - 支持规则间通信（共享上下文）               │
└─────────────────────────────────────────────────┘
    ↓
┌─────────────────────────────────────────────────┐
│  4. 合并/去重 Actions                            │
└─────────────────────────────────────────────────┘
    ↓
输出 DecisionResult
```

## 决策引擎核心逻辑

```typescript
function decide(event: TanmiEvent, state: SessionState, config: PlatformConfig): DecisionResult {
  const actions = [];

  // 1. 检查这个事件是否已被更高优先级的来源处理
  if (event.source === 'mcp' && config.hooks.enabled && config.hooks.events.includes(event.event)) {
    // Hook 已经处理了，MCP 不需要重复
    return { shouldRespond: false, actions: [] };
  }

  // 2. 收集匹配的规则
  const matchedRules = collectMatchedRules(event, state, config);

  // 3. 按优先级排序
  matchedRules.sort((a, b) => a.priority - b.priority);

  // 4. 依次执行规则
  const ctx = { event, state, config, workspace: state.workspace, node: state.focusedNode };
  for (const rule of matchedRules) {
    const action = rule.execute(ctx);
    if (action) {
      actions.push(action);
    }
    if (action?.stopPropagation) {
      break;
    }
  }

  // 5. 去重和合并
  const dedupedActions = deduplicateActions(actions);

  return { shouldRespond: dedupedActions.length > 0, actions: dedupedActions };
}
```

## 调用流程示例

### Claude Code (有 Hook)

```
Hook 触发 SessionStart
    → 事件: { source: 'hook', platform: 'claude-code', event: 'session_start' }
    → 决策: 需要注入工作区上下文
    → 输出: { hookSpecificOutput: { additionalContext: "..." } }
```

### Web Chat (无 Hook)

```
AI 主动调用 MCP 工具 context_check
    → 事件: { source: 'mcp', platform: 'web', event: 'session_start' }
    → 决策: 检查 Hook 配置 → 无 Hook，需要响应
    → 输出: MCP 返回值，AI 自行处理
```

### Cursor (Hook 不全)

```
Cursor 没有 SessionStart Hook，AI 首次响应时调用 context_check
    → 事件: { source: 'mcp', platform: 'cursor', event: 'session_start' }
    → 决策: 检查配置 → Cursor 的 session_start 没被 Hook 覆盖，需要响应
    → 输出: MCP 返回值
```

## 模块划分

```
src/
├── events/
│   ├── types.ts              # 统一事件类型定义
│   └── collectors/           # 各来源的事件收集器
│       ├── hook.ts
│       └── mcp.ts
│
├── decision/
│   ├── engine.ts             # 决策引擎
│   ├── state.ts              # 状态管理
│   └── rules/                # 决策规则
│       ├── index.ts          # 规则注册与加载
│       ├── builtin/          # 内置规则
│       │   ├── context-inject.ts
│       │   ├── smart-reminder.ts
│       │   ├── binding-hint.ts
│       │   └── plan-confirm.ts
│       └── loader.ts         # 用户规则加载器
│
├── output/
│   ├── formatters/           # 各平台格式化器
│   │   ├── claude-code.ts
│   │   ├── cursor.ts
│   │   └── mcp.ts
│   └── dispatcher.ts         # 响应分发
│
├── config/
│   └── platforms.ts          # 平台配置定义
│
└── tools/
    └── context-check.ts      # MCP 工具，供无 Hook 平台使用
```

## 新增 MCP 工具

```typescript
{
  name: "context_check",
  description: "检查当前会话是否需要上下文注入（无 Hook 平台使用）",
  inputSchema: {
    properties: {
      sessionId: { type: "string", description: "会话 ID" },
      trigger: {
        type: "string",
        enum: ["session_start", "before_response"],
        description: "触发时机"
      }
    },
    required: ["sessionId", "trigger"]
  }
}

// 返回
{
  bound: boolean,
  context?: string,      // 工作区上下文（如已绑定）
  reminder?: string,     // 智能提醒（如有）
  hint?: string          // 绑定提示（如未绑定但检测到关键词）
}
```

## 迁移计划

### Phase 1: 核心框架
- [ ] 定义统一事件类型
- [ ] 实现决策引擎基础框架
- [ ] 迁移现有内置规则

### Phase 2: 平台适配
- [ ] 重构 Claude Code Hook 适配器
- [ ] 重构 Cursor Hook 适配器
- [ ] 实现 `context_check` MCP 工具

### Phase 3: 规则扩展
- [ ] 实现用户规则加载器
- [ ] 支持工作区级规则
- [ ] 支持全局规则配置

### Phase 4: 文档与测试
- [ ] 更新用户文档
- [ ] 添加规则编写指南
- [ ] 完善单元测试

## 附录：平台配置示例

```typescript
const platformConfigs: Record<string, PlatformConfig> = {
  'claude-code': {
    platform: 'claude-code',
    hooks: {
      enabled: true,
      events: ['session_start', 'prompt_submit']
    },
    capabilities: {
      agentMessage: true,
      userMessage: false,
      systemPrompt: false
    },
    formatter: formatForClaudeCode
  },
  'cursor': {
    platform: 'cursor',
    hooks: {
      enabled: true,
      events: ['prompt_submit']  // 没有 session_start
    },
    capabilities: {
      agentMessage: true,
      userMessage: true,
      systemPrompt: false
    },
    formatter: formatForCursor
  },
  'web-chat': {
    platform: 'web-chat',
    hooks: {
      enabled: false,
      events: []
    },
    capabilities: {
      agentMessage: false,
      userMessage: false,
      systemPrompt: true
    },
    formatter: formatForMcp
  }
};
```
