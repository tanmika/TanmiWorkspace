# TanmiWorkspace 使用指南

面向 AI 编程助手的分形任务管理系统

---

## 1. 快速上手

```bash
# 克隆、安装、构建
git clone <repo_url> && cd tanmi-workspace
npm install && cd web && npm install && cd ..
npm run build:all

# 安装 Hook（推荐）
./scripts/install-global.sh
```

将 MCP 服务配置添加到你的 AI 工具中（详见附录 A）。

在你与AI对话前加上：

> "使用工作台"

AI 将会调用工作台来管理你的任务。

---

## 2. 为什么需要工作台

如果你正在使用 OpenSpec 或类似的规范驱动流程，可能遇到过这些问题：

| 痛点 | 具体表现 |
|------|----------|
| **流程刚性** | 步骤 3 失败了，只能修改文档从头重跑，前期成果作废 |
| **上下文污染** | 任务做到后期，AI 被前面步骤的信息干扰，判断出错 |
| **无法动态调整** | 执行中发现需要拆分子任务，流程不支持，只能硬着头皮继续 |
| **决策不可追溯** | 想知道"当时为什么这样决定"，没有记录，只能靠记忆 |
| **中断成本高** | 对话中断后，要花很长时间跟 AI "同步进度" |

TanmiWorkspace 针对这些问题的改进：

| 维度 | 线性流程 | 工作台 |
|------|----------|--------|
| 流程结构 | 线性 TodoList | 分形树状结构 |
| 上下文范围 | 全局共享 | 按节点隔离 |
| 任务变更 | 修改文档重跑 | 动态分裂子节点 |
| 回溯能力 | 弱 | 保留完整执行路径 |
| 中断恢复 | 手动同步 | 自动恢复上下文 |

**核心设计理念**：

- **分形任务分解**：任务可无限分解，从宏观目标平滑过渡到微观实现
- **状态本地化**：所有数据以 Markdown + JSON 存储在项目目录，可读、可移植、可纳入版本控制
- **人在环路**：通过强制的计划审阅机制，确保用户对 AI 行为有最终控制权

---

## 3. 核心工作流

### 阶段一：初始化与信息收集

用户提出目标后，AI 初始化工作区，并执行信息收集——扫描项目结构、分析技术栈、识别关键文档。

> **你**："使用工作台，重构项目的数据库访问层。"
>
> **AI**："工作区已创建，Web 界面：http://localhost:19540/workspace/ws-xxx
>
> 正在分析项目结构... 发现以下相关文档：
> - docs/db_schema.md - 数据库表结构
> - src/models/ - 现有数据模型
>
> 是否将这些作为参考文档？"
>
> **你**："是的。"

### 阶段二：计划审阅与调整

AI 基于收集的信息将任务分解为节点树，并要求用户审阅确认。

> **AI**："分析完成，计划如下：
>
> ```
> [○] 重构数据库访问层
>  ├── [○] 定义统一的 Repository 接口
>  ├── [○] 迁移 UserRepository
>  ├── [○] 迁移 OrderRepository
>  └── [○] 编写集成测试
> ```
>
> 确认后开始执行，需要调整吗？"
>
> **你**："在迁移之前，先加一个'分析现有代码耦合点'的步骤。"
>
> **AI**："已添加。更新后的计划：
>
> ```
> [○] 重构数据库访问层
>  ├── [○] 分析现有代码耦合点（新增）
>  ├── [○] 定义统一的 Repository 接口
>  ├── [○] 迁移 UserRepository
>  ├── [○] 迁移 OrderRepository
>  └── [○] 编写集成测试
> ```
>
> 确认开始？"
>
> **你**："开始。"

### 阶段三：迭代执行与动态调整

AI 按计划逐节点执行。每个节点是独立的工作单元，执行过程中可根据实际情况动态调整。

> **AI**："正在执行'分析现有代码耦合点'..."
>
> **AI**："分析完成。发现 3 处直接依赖数据库连接的代码，需要先解耦。建议将'解耦数据库直连代码'分裂为前置子任务。是否同意？"
>
> **你**："同意。"
>
> **AI**："已创建子任务。任务树更新：
>
> ```
> [◐] 重构数据库访问层
>  ├── [◐] 分析现有代码耦合点
>  │    └── [○] 解耦数据库直连代码  < 新增
>  ├── [○] 定义统一的 Repository 接口
>  ...
> ```
>
> 开始执行解耦任务..."

### 阶段四：进度追踪与任务收尾

通过对话或 Web UI 追踪进度。所有子节点完成后，AI 会提醒进行总结。

> **你**："当前进度如何？"
>
> **AI**："重构进度：
>
> ```
> [◐] 重构数据库访问层
>  ├── [●] 分析现有代码耦合点 - 已完成
>  │    └── [●] 解耦数据库直连代码 - 已完成
>  ├── [●] 定义统一的 Repository 接口 - 已完成
>  ├── [◐] 迁移 UserRepository - 进行中
>  ├── [○] 迁移 OrderRepository - 待开始
>  └── [○] 编写集成测试 - 待开始
> ```
>
> 当前正在迁移 UserRepository，预计还需完成 3 个节点。"

---

## 4. 使用场景示例

### 场景一：简单需求（顺利完成）

> **你**："使用工作台，给用户表加一个 last_login_at 字段。"
>
> **AI**："工作区已创建。计划：
> 1. 修改数据库 migration
> 2. 更新 User model
> 3. 在登录逻辑中记录时间
>
> 确认开始？"
>
> **你**："开始。"
>
> *（AI 依次执行，记录日志）*
>
> **AI**："全部完成，修改了 3 个文件。结论已记录到工作台。"

这是最简单的情况：计划 → 确认 → 执行 → 完成。

### 场景二：执行中需要调整（动态分裂）

> **你**："使用工作台，实现用户登录功能。"
>
> **AI**："计划：
> 1. 设计 users 表
> 2. 实现登录接口
> 3. 添加 JWT 认证
>
> 确认开始？"
>
> **你**："开始。"
>
> *（执行到第 2 步时）*
>
> **AI**："执行中发现问题：现有密码是明文存储的，存在安全风险。需要先迁移到哈希存储。
>
> 建议将'密码哈希迁移'分裂为前置子任务。是否同意？"
>
> **你**："同意。"
>
> **AI**："已分裂。任务树更新：
> ```
> [◐] 实现登录接口（暂停）
>  └── [○] 密码哈希迁移（新增）
> ```
> 开始执行迁移..."

**工作台优势**：执行中发现问题可动态分裂，无需推倒重来。线性流程只能修改文档从头再跑。

### 场景三：复杂排查（多分支、失败记录、回溯）

> **你**："使用工作台，排查登录偶发超时问题。"
>
> **AI**："创建排查任务。根据日志分析，有 3 个可能原因：
> 1. 数据库连接池配置
> 2. 网络延迟
> 3. 慢查询
>
> 我将创建 3 个子节点逐一验证。确认开始？"
>
> **你**："开始。"
>
> *（验证假设 1）*
>
> **AI**："假设 1 验证完成：连接池配置正常（max_connections=100），已排除。
> ```
> [◐] 排查登录超时
>  ├── [✕] 假设1：连接池 - 已排除
>  ├── [○] 假设2：网络延迟
>  └── [○] 假设3：慢查询
> ```
> 继续验证假设 2？"
>
> *（假设 2 也排除，假设 3 找到根因）*
>
> **AI**："根因确认：users 表缺少索引导致慢查询。已创建修复子任务并完成。"
>
> **你**："回顾一下排查过程。"
>
> **AI**："根据工作台记录：
> - 假设 1（连接池）：配置检查正常，排除
> - 假设 2（网络延迟）：ping < 1ms，排除
> - 假设 3（慢查询）：**确认为根因**，添加索引后解决"

**工作台优势**：
- 失败的验证保留完整记录
- 可并行创建多个假设分支
- 随时回顾"排除了什么、为什么排除"

---

## 5. 中断与恢复

### 对话中断后继续

> **你**："继续之前的登录功能任务。"
>
> **AI**："已恢复上下文。上次完成了数据库设计，正在实现登录接口。继续执行？"

### 切换任务

> **你**："切换到博客系统那个任务。"
>
> **AI**："已切换到'博客系统'工作区。当前进度：正在实现文章列表接口。"

### 查看所有任务

> **你**："我有哪些进行中的任务？"
>
> **AI**："活跃工作区：
> 1. 用户登录功能 - 进行中 (2/4)
> 2. 博客系统 - 进行中 (5/8)
> 3. 数据导出功能 - 待开始"

---

## 6. Web 界面

启动命令：

```bash
tanmi-workspace webui
# 服务启动后自动打开浏览器（默认端口 19540）
```

**主要功能**：

| 功能 | 说明 |
|------|------|
| 工作区列表 | 查看所有工作区，按状态筛选 |
| 任务树视图 | 树状展示节点，状态图标一目了然 |
| 节点详情 | 查看需求、结论、日志、问题 |
| 进度统计 | 各状态节点数量汇总 |

**状态图标**：

| 图标 | 状态 |
|------|------|
| ○ | 待开始 |
| ◐ | 进行中 |
| ● | 已完成 |
| ✕ | 失败 |
| ⊘ | 已取消 |

---

## 7. 常见操作

### 查看进度

> "当前任务状态如何？"
>
> "给我看一下任务树。"

### 调整计划

> "这个步骤先不做。"
>
> "这个任务太大了，拆分一下。"

### 追加需求

> "再加一个记住密码功能。"

AI 会重新打开任务，在原有基础上添加新节点。

### 回顾决策

> "当时为什么选择 JWT 而不是 Session？"

AI 会从工作台记录中查找当时的决策依据。

### 归档任务

> "把这个任务归档。"

归档后不在活跃列表显示，数据保留，可随时恢复。

---

## 8. 最佳实践

1. **明确意图**：以"使用工作台..."开头，可更稳定地触发系统

2. **先确认后执行**：充分利用计划审阅阶段，确保方向正确。这能节省大量返工时间

3. **为决策提供上下文**：要求 AI 做调整时，简要说明原因。例如"用 JWT 因为要支持移动端"。AI 会记录下来，便于后续回顾

4. **主动要求拆分**：如果某个节点看起来过于复杂或耗时，主动要求拆分为更小的子节点

5. **及时归档**：完成的任务及时归档，保持活跃列表整洁

---

## 9. 常见问题

### AI 没有使用工作台？

- 确认 MCP 服务配置正确（见附录 A）
- 确认已重启 AI 工具
- 在指令中明确说"使用工作台"

### AI 跳过计划审阅直接执行？

立即打断：

> "先展示计划，等我确认后再开始。"

### 任务做到一半，AI 似乎忘了之前的内容？

> "从工作台获取当前任务的上下文。"

AI 会重新读取任务状态和历史记录。

### 想修改已完成的步骤？

> "重新打开'数据库设计'那个步骤。"

AI 会重新激活该节点。

### Web 界面无法访问？

1. 确认已运行 `tanmi-workspace webui`
2. 查看服务状态：`tanmi-workspace webui status`
3. 尝试更换端口：`HTTP_PORT=19542 tanmi-workspace webui`

### 数据存在哪里？

项目目录下的 `.tanmi-workspace` 文件夹，完全本地化，不上传云端。

### 可以手动编辑数据文件吗？

- **可以**：`*.md` 文件（Info.md、Log.md 等）
- **不推荐**：`graph.json`（结构数据，手动编辑可能破坏一致性）

---

## 附录 A：安装与配置

### 环境要求

- Node.js 20.19+ 或 22.12+
- 支持 MCP 的 AI 工具（Claude Code、Cursor、Windsurf、Cline 等）

### 安装步骤

```bash
git clone <仓库地址>
cd tanmi-workspace
npm install
cd web && npm install && cd ..
npm run build:all
```

### 配置 MCP 服务

在 AI 工具的配置文件中添加：

```json
{
  "mcpServers": {
    "tanmi-workspace": {
      "command": "node",
      "args": ["/path/to/tanmi-workspace/dist/check-node-version.js"]
    }
  }
}
```

配置文件位置：

| 平台 | 路径 |
|------|------|
| Claude Code | `~/.claude/settings.json` |
| Cursor | `~/.cursor/mcp.json` |
| Windsurf | `~/.codeium/windsurf/mcp_config.json` |

### 权限与 Hook

- **Claude Code 权限**：`./scripts/setup-claude-code.sh`
- **全局 Hook（推荐）**：`./scripts/install-global.sh`

安装后需重启 AI 工具。

### 验证安装

> "使用工作台，介绍一下你自己。"

如果返回 TanmiWorkspace 的介绍信息，说明配置成功。
