# ç»“æ„åŒ–æ„å›¾å£°æ˜åŠŸèƒ½è®¾è®¡

## ä¸€ã€é—®é¢˜èƒŒæ™¯

### 1.1 é—®é¢˜åœºæ™¯

ç”¨æˆ·åé¦ˆï¼šAI åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ–¹æ¡ˆå‘ç”Ÿå˜æ›´åï¼Œæ²¡æœ‰æ›´æ–°èŠ‚ç‚¹çš„ requirement å’Œç›¸å…³èŠ‚ç‚¹ä¿¡æ¯ã€‚

**å…·ä½“æ¡ˆä¾‹**ï¼š
```
ç”¨æˆ·æå‡ºä»»åŠ¡ï¼šå®ç° portrait_mask_hp ç¼“å­˜æ”¯æŒ
    â†“
AI å¼€å§‹æ‰§è¡Œï¼ŒåŸæ–¹æ¡ˆï¼šåœ¨ BgReplaceCache ä¸­æ·»åŠ å­—æ®µ
    â†“
ç”¨æˆ·åé¦ˆï¼športrait_mask_hp ä¸ä¾èµ– EffectBgReplaceï¼Œåº”è¯¥ç”¨ç‹¬ç«‹ç»“æ„
    â†“
AI è°ƒæ•´æ–¹æ¡ˆï¼Œæ”¹ç”¨ç‹¬ç«‹çš„ CommonCache ç»“æ„
    â†“
AI å®Œæˆä»»åŠ¡ï¼Œåªåœ¨ conclusion ä¸­å†™äº†æ–°æ–¹æ¡ˆ
    â†“
é—®é¢˜ï¼šrequirement è¿˜æ˜¯æ—§æ–¹æ¡ˆï¼Œçˆ¶èŠ‚ç‚¹/å…„å¼ŸèŠ‚ç‚¹ä¿¡æ¯ä¹Ÿæ²¡æ›´æ–°
```

### 1.2 é—®é¢˜æ ¹å› åˆ†æ

1. **AI æ²¡æœ‰æ„è¯†åˆ°éœ€è¦æ›´æ–°å…ƒæ•°æ®**ï¼šä¸“æ³¨äºä»£ç å®ç°ï¼Œå¿½ç•¥äº†å·¥ä½œåŒºä¿¡æ¯åŒæ­¥
2. **ç°æœ‰æé†’æœºåˆ¶ä¸è¶³**ï¼š
   - instructions.ts ä¸­çš„æŒ‡å¯¼æ˜¯"è¢«åŠ¨"çš„ï¼ŒAI éœ€è¦ä¸»åŠ¨æŸ¥è¯¢
   - complete æ—¶çš„ hint å¤ªæ™šï¼Œæ–¹æ¡ˆå˜æ›´å‘ç”Ÿåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­
   - node_update è¿”å›å€¼æ²¡æœ‰ hint
3. **ç¼ºä¹ç»“æ„åŒ–è§¦å‘æœºåˆ¶**ï¼šæ— æ³•ç²¾ç¡®è¯†åˆ«"æ–¹æ¡ˆå˜æ›´"åœºæ™¯

### 1.3 æ ¸å¿ƒæ´å¯Ÿ

**å…³é”®æ—¶æœº**ï¼šAI è°ƒç”¨å·¥å…·æ—¶ï¼ˆè€Œéé˜…è¯»æ–‡æ¡£æ—¶ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼šé€šè¿‡è®© AI æ˜¾å¼å£°æ˜æ“ä½œçš„"ç±»å‹/æ„å›¾"ï¼Œç³»ç»Ÿå¯ä»¥ï¼š
1. ç²¾ç¡®è§¦å‘ç›¸åº”çš„æé†’
2. è®© AI æ›´æœ‰æ„è¯†åœ°æ€è€ƒè‡ªå·±åœ¨åšä»€ä¹ˆ
3. ç»“æ„åŒ–æ•°æ®ä¾¿äºåç»­åˆ†æ

## äºŒã€è®¾è®¡æ–¹æ¡ˆ

### 2.1 æ ¸å¿ƒæœºåˆ¶ï¼šæ„å›¾å£°æ˜ + æ™ºèƒ½æé†’

```
AI è°ƒç”¨å·¥å…·æ—¶å£°æ˜æ„å›¾ï¼ˆå¦‚ type="scheme_change"ï¼‰
    â†“
ç³»ç»Ÿæ ¹æ®æ„å›¾ç±»å‹è¿”å›é’ˆå¯¹æ€§çš„ hint/actionRequired
    â†“
AI æ”¶åˆ°æé†’åæ‰§è¡Œç›¸åº”æ“ä½œï¼ˆå¦‚æ›´æ–° requirementï¼‰
```

### 2.2 æ¨å¹¿èŒƒå›´

| å·¥å…· | æ–°å¢å‚æ•° | å‚æ•°ç±»å‹ | è§¦å‘çš„æé†’ |
|------|----------|----------|------------|
| log_append | `type` | å¿…å¡«æšä¸¾ | scheme_change â†’ æ›´æ–° requirement |
| node_update | `reason` | å¯é€‰æšä¸¾ | scheme_change â†’ åŒæ­¥ç›¸å…³èŠ‚ç‚¹ |
| node_transition | `schemeChanged` | å¯é€‰å¸ƒå°” | true â†’ æ£€æŸ¥ requirement |

### 2.3 ä¼˜å…ˆçº§åˆ’åˆ†

**P0ï¼ˆå¿…é¡»å®ç°ï¼‰**ï¼š
- log_append å¢åŠ  type - æœ€å¸¸è°ƒç”¨ï¼Œè¦†ç›–é¢æœ€å¹¿

**P1ï¼ˆå»ºè®®å®ç°ï¼‰**ï¼š
- node_transition complete å¢åŠ  schemeChanged - æœ€åå…³å¡

**P2ï¼ˆå¯é€‰å®ç°ï¼‰**ï¼š
- node_update å¢åŠ  reason - è¡¥å……è¦†ç›–

### 2.4 å®Œæ•´ç±»å‹-åœºæ™¯-æç¤ºå¯¹ç…§è¡¨

#### 2.4.1 log_append type å‚æ•°

| ç±»å‹å€¼ | ä¸­æ–‡æ ‡ç­¾ | é€‚ç”¨åœºæ™¯ | åœºæ™¯ç¤ºä¾‹ | ç³»ç»Ÿæç¤º |
|--------|----------|----------|----------|----------|
| `progress` | è¿›å±• | å¸¸è§„æ‰§è¡Œè¿›åº¦è®°å½•ï¼Œä»»åŠ¡æ­£å¸¸æ¨è¿› | "å®Œæˆäº† API æ¥å£å®ç°"ã€"å·²åˆ›å»ºæ•°æ®åº“è¡¨" | æ— ç‰¹æ®Šæç¤º |
| `scheme_change` | æ–¹æ¡ˆå˜æ›´ | å®ç°æ–¹æ¡ˆå‘ç”Ÿè°ƒæ•´ï¼Œä¸åŸ requirement ä¸åŒ | "æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œæ”¹ç”¨ CommonCache ç»“æ„"ã€"åŸæ–¹æ¡ˆä¸å¯è¡Œï¼Œæ”¹ç”¨ç­–ç•¥æ¨¡å¼" | âš ï¸ **æ–¹æ¡ˆå˜æ›´å·²è®°å½•**ã€‚è¯·åŠ¡å¿…ï¼š<br>1. ä½¿ç”¨ node_update æ›´æ–°å½“å‰èŠ‚ç‚¹çš„ requirement<br>2. æ£€æŸ¥çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹æ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°æ ‡é¢˜/éœ€æ±‚ |
| `discovery` | å‘ç° | è°ƒç ”è¿‡ç¨‹ä¸­å‘ç°é‡è¦ä¿¡æ¯æˆ–äº‹å® | "å‘ç° portrait_mask_hp åœ¨ AIServerService ä¸­ç”Ÿæˆ"ã€"å‘ç°ç°æœ‰ä»£ç å·²æœ‰ç±»ä¼¼å®ç°" | ğŸ’¡ å‘ç°å·²è®°å½•ã€‚å¦‚æœè¿™ä¸ªå‘ç°å½±å“äº†åŸæœ‰æ–¹æ¡ˆï¼Œè€ƒè™‘ä½¿ç”¨ type=scheme_change è®°å½•æ–¹æ¡ˆå˜æ›´ã€‚ |
| `decision` | å†³ç­– | åšå‡ºå…³é”®æŠ€æœ¯å†³ç­–æˆ–æ–¹å‘é€‰æ‹© | "å†³å®šé‡‡ç”¨ç­–ç•¥æ¨¡å¼è€Œéå·¥å‚æ¨¡å¼"ã€"å†³å®šå…ˆå®Œæˆ A æ¨¡å—å†åš B" | ğŸ’¡ å†³ç­–å·²è®°å½•ã€‚å¦‚æœè¿™ä¸ªå†³ç­–æ”¹å˜äº†åŸæœ‰æ–¹æ¡ˆï¼Œè¯·åŒæ—¶æ›´æ–° requirementã€‚ |
| `problem` | é—®é¢˜ | é‡åˆ°é˜»ç¢ã€é”™è¯¯æˆ–éœ€è¦è§£å†³çš„é—®é¢˜ | "ç¼–è¯‘å¤±è´¥ï¼Œç¼ºå°‘ä¾èµ–"ã€"æµ‹è¯•æœªé€šè¿‡ï¼Œéœ€è¦ä¿®å¤" | ğŸ’¡ é—®é¢˜å·²è®°å½•ã€‚å¦‚æœé—®é¢˜å¤æ‚ï¼Œè€ƒè™‘ä½¿ç”¨ problem_update è¯¦ç»†è®°å½•é—®é¢˜å’Œä¸‹ä¸€æ­¥è®¡åˆ’ã€‚ |

#### 2.4.2 node_transition schemeChanged å‚æ•°

| å‚æ•°å€¼ | é€‚ç”¨åœºæ™¯ | åœºæ™¯ç¤ºä¾‹ | ç³»ç»Ÿæç¤º |
|--------|----------|----------|----------|
| `true` | æ‰§è¡Œè¿‡ç¨‹ä¸­æ–¹æ¡ˆå‘ç”Ÿäº†è°ƒæ•´ï¼Œå®é™…å®ç°ä¸åŸ requirement æè¿°ä¸åŒ | ç”¨æˆ·åé¦ˆåè°ƒæ•´äº†å®ç°æ–¹æ¡ˆï¼›å‘ç°åŸæ–¹æ¡ˆä¸å¯è¡Œæ”¹ç”¨å…¶ä»–æ–¹æ¡ˆ | âš ï¸ æ‚¨å£°æ˜äº†æ–¹æ¡ˆæœ‰å˜æ›´ã€‚è¯·ç¡®è®¤ï¼š<br>1. å½“å‰èŠ‚ç‚¹çš„ requirement æ˜¯å¦å·²æ›´æ–°ä¸ºå®é™…å®ç°çš„æ–¹æ¡ˆï¼Ÿ<br>2. çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹çš„æ ‡é¢˜/éœ€æ±‚æ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°ï¼Ÿ |
| `false` æˆ–ä¸å¡« | æŒ‰åŸæ–¹æ¡ˆæ­£å¸¸å®Œæˆï¼Œæ— éœ€ç‰¹æ®Šæ£€æŸ¥ | æŒ‰ç…§ requirement æè¿°å®Œæˆä»»åŠ¡ | æ— ç‰¹æ®Šæç¤ºï¼ˆä¿æŒåŸæœ‰ complete æç¤ºï¼‰ |

#### 2.4.3 node_update reason å‚æ•°ï¼ˆP2ï¼Œå¯é€‰ï¼‰

| å‚æ•°å€¼ | ä¸­æ–‡æ ‡ç­¾ | é€‚ç”¨åœºæ™¯ | åœºæ™¯ç¤ºä¾‹ | ç³»ç»Ÿæç¤º |
|--------|----------|----------|----------|----------|
| `fix_typo` | ä¿®æ­£é”™åˆ«å­— | ä¿®æ­£æ ‡é¢˜/éœ€æ±‚ä¸­çš„æ‹¼å†™æˆ–æ ¼å¼é”™è¯¯ | ä¿®æ­£ "implment" â†’ "implement" | æ— ç‰¹æ®Šæç¤º |
| `add_detail` | è¡¥å……ç»†èŠ‚ | åœ¨åŸæœ‰åŸºç¡€ä¸Šè¡¥å……æ›´å¤šç»†èŠ‚æè¿° | è¡¥å……æ¥å£å‚æ•°è¯´æ˜ã€æ·»åŠ è¾¹ç•Œæ¡ä»¶ | æ— ç‰¹æ®Šæç¤º |
| `scheme_change` | æ–¹æ¡ˆå˜æ›´ | æ›´æ–° requirement ä»¥åæ˜ æ–°çš„å®ç°æ–¹æ¡ˆ | å°† "åœ¨ BgReplaceCache ä¸­æ·»åŠ å­—æ®µ" æ”¹ä¸º "ä½¿ç”¨ç‹¬ç«‹çš„ CommonCache ç»“æ„" | ğŸ’¡ æ–¹æ¡ˆå˜æ›´å·²æ›´æ–°åˆ°èŠ‚ç‚¹ã€‚è¯·æ£€æŸ¥çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹æ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°ã€‚ |
| `sync_impl` | ä¸å®ç°åŒæ­¥ | å®ç°å®Œæˆåï¼Œå°† requirement æ›´æ–°ä¸ºå®é™…å®ç°çš„å†…å®¹ | å°†æ¨¡ç³Šçš„éœ€æ±‚æè¿°æ”¹ä¸ºå…·ä½“çš„å®ç°ç»†èŠ‚ | ğŸ’¡ éœ€æ±‚å·²ä¸å®ç°åŒæ­¥ã€‚ |
| `other` | å…¶ä»– | å…¶ä»–æ›´æ–°åŸå›  | æ ¹æ®è¯„å®¡æ„è§ä¿®æ”¹ã€é‡æ–°ç»„ç»‡æè¿°ç­‰ | æ— ç‰¹æ®Šæç¤º |

#### 2.4.4 ç±»å‹é€‰æ‹©å†³ç­–æ ‘

```
è®°å½•æ—¥å¿—æ—¶ï¼Œå¦‚ä½•é€‰æ‹© typeï¼Ÿ
    â”‚
    â”œâ”€ æ–¹æ¡ˆæ˜¯å¦å‘ç”Ÿäº†å˜åŒ–ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ type = "scheme_change"
    â”‚   â””â”€ å¦ â†“
    â”‚
    â”œâ”€ æ˜¯å¦å‘ç°äº†é‡è¦ä¿¡æ¯ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ type = "discovery"
    â”‚   â””â”€ å¦ â†“
    â”‚
    â”œâ”€ æ˜¯å¦åšå‡ºäº†å…³é”®å†³ç­–ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ type = "decision"
    â”‚   â””â”€ å¦ â†“
    â”‚
    â”œâ”€ æ˜¯å¦é‡åˆ°äº†é—®é¢˜ï¼Ÿ
    â”‚   â”œâ”€ æ˜¯ â†’ type = "problem"
    â”‚   â””â”€ å¦ â†“
    â”‚
    â””â”€ å¸¸è§„è¿›åº¦è®°å½• â†’ type = "progress"
```

```
å®ŒæˆèŠ‚ç‚¹æ—¶ï¼ŒschemeChanged å¦‚ä½•è®¾ç½®ï¼Ÿ
    â”‚
    â”œâ”€ æœ€ç»ˆå®ç°ä¸åŸ requirement æè¿°æ˜¯å¦ä¸€è‡´ï¼Ÿ
    â”‚   â”œâ”€ ä¸€è‡´ â†’ schemeChanged = false æˆ–ä¸å¡«
    â”‚   â””â”€ ä¸ä¸€è‡´ â†“
    â”‚
    â”œâ”€ æ˜¯å¦å·²ç»æ›´æ–°äº† requirementï¼Ÿ
    â”‚   â”œâ”€ å·²æ›´æ–° â†’ schemeChanged = trueï¼ˆè§¦å‘äºŒæ¬¡ç¡®è®¤ï¼‰
    â”‚   â””â”€ æœªæ›´æ–° â†’ å…ˆæ›´æ–° requirementï¼Œå† schemeChanged = true
    â”‚
    â””â”€ æ³¨æ„ï¼šå³ä½¿ schemeChanged = trueï¼Œä¹Ÿåº”è¯¥å…ˆæ›´æ–°å¥½ requirement
```

## ä¸‰ã€è¯¦ç»†è®¾è®¡

### 3.1 log_append å¢åŠ  type

#### 3.1.1 ç±»å‹å®šä¹‰

```typescript
// src/types/context.ts

/**
 * æ—¥å¿—ç±»å‹
 */
export type LogType =
  | "progress"        // è¿›å±•ï¼šå¸¸è§„æ‰§è¡Œè¿›åº¦è®°å½•
  | "scheme_change"   // æ–¹æ¡ˆå˜æ›´ï¼šå®ç°æ–¹æ¡ˆå‘ç”Ÿè°ƒæ•´
  | "discovery"       // å‘ç°ï¼šè°ƒç ”è¿‡ç¨‹ä¸­çš„å‘ç°
  | "decision"        // å†³ç­–ï¼šåšå‡ºçš„å…³é”®å†³å®š
  | "problem";        // é—®é¢˜ï¼šé‡åˆ°çš„é—®é¢˜æˆ–é˜»ç¢

/**
 * log_append è¾“å…¥
 */
export interface LogAppendParams {
  workspaceId: string;
  nodeId?: string;
  operator: "AI" | "Human";
  type: LogType;        // æ–°å¢ï¼šå¿…å¡«
  event: string;
}
```

#### 3.1.2 å·¥å…·å®šä¹‰æ›´æ–°

```typescript
// src/tools/log.ts

export const logAppendTool: Tool = {
  name: "log_append",
  description: `è¿½åŠ æ—¥å¿—è®°å½•åˆ°èŠ‚ç‚¹æˆ–å…¨å±€æ—¥å¿—ã€‚

**æ—¥å¿—ç±»å‹è¯´æ˜**ï¼š
| ç±»å‹ | ä½¿ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|----------|------|
| progress | å¸¸è§„æ‰§è¡Œè¿›åº¦ | "å®Œæˆäº† API æ¥å£å®ç°" |
| scheme_change | æ–¹æ¡ˆå‘ç”Ÿè°ƒæ•´ | "æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œæ”¹ç”¨ CommonCache ç»“æ„" |
| discovery | è°ƒç ”ä¸­çš„å‘ç° | "å‘ç° portrait_mask_hp åœ¨ AIServerService ä¸­ç”Ÿæˆ" |
| decision | å…³é”®å†³ç­– | "å†³å®šé‡‡ç”¨ç­–ç•¥æ¨¡å¼è€Œéå·¥å‚æ¨¡å¼" |
| problem | é‡åˆ°é—®é¢˜ | "ç¼–è¯‘å¤±è´¥ï¼Œç¼ºå°‘ä¾èµ–" |

**é‡è¦**ï¼šå½“ type=scheme_change æ—¶ï¼Œè¯·åŒæ—¶ä½¿ç”¨ node_update æ›´æ–° requirementã€‚`,
  inputSchema: {
    type: "object",
    properties: {
      workspaceId: {
        type: "string",
        description: "å·¥ä½œåŒº ID",
      },
      nodeId: {
        type: "string",
        description: "èŠ‚ç‚¹ IDï¼ˆä¸ºç©ºåˆ™è¿½åŠ åˆ°å…¨å±€æ—¥å¿—ï¼‰",
      },
      operator: {
        type: "string",
        enum: ["AI", "Human"],
        description: "æ“ä½œè€…",
      },
      type: {
        type: "string",
        enum: ["progress", "scheme_change", "discovery", "decision", "problem"],
        description: "æ—¥å¿—ç±»å‹ï¼ˆå¿…å¡«ï¼‰",
      },
      event: {
        type: "string",
        description: "äº‹ä»¶æè¿°",
      },
    },
    required: ["workspaceId", "operator", "type", "event"],
  },
};
```

#### 3.1.3 æœåŠ¡å®ç°æ›´æ–°

```typescript
// src/services/LogService.ts

async append(params: LogAppendParams): Promise<LogAppendResult> {
  const { workspaceId, nodeId, operator, type, event } = params;

  // ... ç°æœ‰é€»è¾‘ ...

  // æ ¹æ®æ—¥å¿—ç±»å‹ç”Ÿæˆ hint
  let hint: string | undefined;

  if (type === "scheme_change") {
    hint = "âš ï¸ **æ–¹æ¡ˆå˜æ›´å·²è®°å½•**ã€‚è¯·åŠ¡å¿…ï¼š\n" +
      "1. ä½¿ç”¨ node_update({ requirement: \"...\" }) æ›´æ–°å½“å‰èŠ‚ç‚¹çš„éœ€æ±‚æè¿°\n" +
      "2. æ£€æŸ¥çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹æ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°æ ‡é¢˜/éœ€æ±‚";
  } else if (type === "discovery") {
    hint = "ğŸ’¡ å‘ç°å·²è®°å½•ã€‚å¦‚æœè¿™ä¸ªå‘ç°å½±å“äº†åŸæœ‰æ–¹æ¡ˆï¼Œè€ƒè™‘ä½¿ç”¨ type=scheme_change è®°å½•æ–¹æ¡ˆå˜æ›´ã€‚";
  } else if (type === "decision") {
    hint = "ğŸ’¡ å†³ç­–å·²è®°å½•ã€‚å¦‚æœè¿™ä¸ªå†³ç­–æ”¹å˜äº†åŸæœ‰æ–¹æ¡ˆï¼Œè¯·åŒæ—¶æ›´æ–° requirementã€‚";
  } else if (type === "problem") {
    hint = "ğŸ’¡ é—®é¢˜å·²è®°å½•ã€‚å¦‚æœé—®é¢˜å¤æ‚ï¼Œè€ƒè™‘ä½¿ç”¨ problem_update è¯¦ç»†è®°å½•é—®é¢˜å’Œä¸‹ä¸€æ­¥è®¡åˆ’ã€‚";
  }
  // progress ç±»å‹ä¸éœ€è¦ç‰¹æ®Šæé†’

  // è¿½åŠ æ—¥å¿—æ—¶è®°å½•ç±»å‹ï¼ˆå¯é€‰ï¼šåœ¨æ—¥å¿—æ ¼å¼ä¸­ä½“ç°ï¼‰
  const typeLabel = this.getTypeLabel(type);
  const formattedEvent = `[${typeLabel}] ${event}`;

  await this.md.appendTypedLogEntry(projectRoot, workspaceId, {
    timestamp,
    operator,
    event: formattedEvent,
  }, nodeId);

  return {
    success: true,
    timestamp,
    hint,
  };
}

private getTypeLabel(type: LogType): string {
  const labels: Record<LogType, string> = {
    progress: "è¿›å±•",
    scheme_change: "æ–¹æ¡ˆå˜æ›´",
    discovery: "å‘ç°",
    decision: "å†³ç­–",
    problem: "é—®é¢˜",
  };
  return labels[type] || type;
}
```

#### 3.1.4 æ—¥å¿—æ ¼å¼å˜åŒ–

**ä¿®æ”¹å‰**ï¼š
```
| æ—¶é—´ | æ“ä½œè€… | äº‹ä»¶ |
|------|--------|------|
| 2025-12-18 13:49:51 | AI | å®Œæˆäº† API æ¥å£å®ç° |
```

**ä¿®æ”¹å**ï¼š
```
| æ—¶é—´ | æ“ä½œè€… | äº‹ä»¶ |
|------|--------|------|
| 2025-12-18 13:49:51 | AI | [è¿›å±•] å®Œæˆäº† API æ¥å£å®ç° |
| 2025-12-18 14:30:22 | AI | [æ–¹æ¡ˆå˜æ›´] æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œæ”¹ç”¨ CommonCache ç»“æ„ |
```

### 3.2 node_transition complete å¢åŠ  schemeChanged

#### 3.2.1 ç±»å‹å®šä¹‰

```typescript
// src/types/node.ts

export interface NodeTransitionParams {
  workspaceId: string;
  nodeId: string;
  action: TransitionAction;
  reason?: string;
  conclusion?: string;
  schemeChanged?: boolean;  // æ–°å¢ï¼šæ–¹æ¡ˆæ˜¯å¦æœ‰å˜æ›´
}
```

#### 3.2.2 å·¥å…·å®šä¹‰æ›´æ–°

```typescript
// src/tools/state.ts

export const nodeTransitionTool: Tool = {
  name: "node_transition",
  description: `å˜æ›´èŠ‚ç‚¹çŠ¶æ€ã€‚...ï¼ˆç°æœ‰æè¿°ï¼‰...

**schemeChanged å‚æ•°è¯´æ˜**ï¼š
- å½“ action=complete æ—¶å¯é€‰å¡«å†™
- å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­æ–¹æ¡ˆå‘ç”Ÿäº†è°ƒæ•´ï¼ˆä¸åŸ requirement ä¸åŒï¼‰ï¼Œè¯·è®¾ä¸º true
- ç³»ç»Ÿä¼šæé†’æ£€æŸ¥ requirement æ˜¯å¦å·²æ›´æ–°`,
  inputSchema: {
    type: "object",
    properties: {
      // ... ç°æœ‰å±æ€§ ...
      schemeChanged: {
        type: "boolean",
        description: "æ–¹æ¡ˆæ˜¯å¦æœ‰å˜æ›´ï¼ˆcomplete æ—¶å¯é€‰ï¼Œå¦‚æœä¸º true è¯·ç¡®ä¿å·²æ›´æ–° requirementï¼‰",
      },
    },
    required: ["workspaceId", "nodeId", "action"],
  },
};
```

#### 3.2.3 æœåŠ¡å®ç°æ›´æ–°

```typescript
// src/services/StateService.ts

// åœ¨ complete é€»è¾‘ä¸­å¢åŠ æ£€æŸ¥
if (action === "complete" && params.schemeChanged === true) {
  // æ£€æŸ¥ requirement æ˜¯å¦åœ¨æœ€è¿‘è¢«æ›´æ–°è¿‡
  const nodeInfo = await this.md.readNodeInfo(projectRoot, workspaceId, nodeId);

  // åœ¨ hint ä¸­å¢åŠ æé†’
  result.hint += "\n\nâš ï¸ æ‚¨å£°æ˜äº†æ–¹æ¡ˆæœ‰å˜æ›´ã€‚è¯·ç¡®è®¤ï¼š\n" +
    "1. å½“å‰èŠ‚ç‚¹çš„ requirement æ˜¯å¦å·²æ›´æ–°ä¸ºå®é™…å®ç°çš„æ–¹æ¡ˆï¼Ÿ\n" +
    "2. çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹çš„æ ‡é¢˜/éœ€æ±‚æ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°ï¼Ÿ";
}
```

### 3.3 node_update å¢åŠ  reasonï¼ˆP2ï¼Œå¯é€‰ï¼‰

#### 3.3.1 ç±»å‹å®šä¹‰

```typescript
// src/types/node.ts

/**
 * èŠ‚ç‚¹æ›´æ–°åŸå› 
 */
export type UpdateReason =
  | "fix_typo"        // ä¿®æ­£é”™åˆ«å­—
  | "add_detail"      // è¡¥å……ç»†èŠ‚
  | "scheme_change"   // æ–¹æ¡ˆå˜æ›´
  | "sync_impl"       // ä¸å®ç°åŒæ­¥
  | "other";          // å…¶ä»–

export interface NodeUpdateParams {
  workspaceId: string;
  nodeId: string;
  title?: string;
  requirement?: string;
  note?: string;
  conclusion?: string;
  reason?: UpdateReason;  // æ–°å¢ï¼šæ›´æ–°åŸå› ï¼ˆå¯é€‰ï¼‰
}
```

#### 3.3.2 æœåŠ¡å®ç°

```typescript
// src/services/NodeService.ts

async update(params: NodeUpdateParams): Promise<NodeUpdateResult> {
  // ... ç°æœ‰é€»è¾‘ ...

  // æ ¹æ® reason ç”Ÿæˆ hint
  let hint: string | undefined;

  if (params.reason === "scheme_change") {
    hint = "ğŸ’¡ æ–¹æ¡ˆå˜æ›´å·²æ›´æ–°åˆ°èŠ‚ç‚¹ã€‚è¯·æ£€æŸ¥çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹æ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°ã€‚";
  }

  return {
    success: true,
    updatedAt: currentTime,
    hint,
  };
}
```

## å››ã€å…¼å®¹æ€§è€ƒè™‘

### 4.1 log_append type å‚æ•°

**é—®é¢˜**ï¼šå°† type è®¾ä¸ºå¿…å¡«ä¼šå¯¼è‡´ç°æœ‰ä»£ç /è„šæœ¬å¤±è´¥

**æ–¹æ¡ˆ**ï¼š
1. **è¿‡æ¸¡æœŸ**ï¼štype è®¾ä¸ºå¯é€‰ï¼Œç¼ºå¤±æ—¶é»˜è®¤ä¸º "progress"
2. **æé†’**ï¼šè¿”å› hint æç¤ºåº”è¯¥æä¾› type
3. **æœªæ¥**ï¼šä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬è®¾ä¸ºå¿…å¡«

```typescript
// è¿‡æ¸¡æœŸå®ç°
const type = params.type || "progress";
let hint = "";

if (!params.type) {
  hint = "ğŸ’¡ å»ºè®®ï¼šè¯·ä¸ºæ—¥å¿—æŒ‡å®š type å‚æ•°ï¼ˆprogress/scheme_change/discovery/decision/problemï¼‰ï¼Œæœ‰åŠ©äºæ›´ç²¾ç¡®çš„å·¥ä½œæµæé†’ã€‚";
}
```

### 4.2 å‘åå…¼å®¹

- æ‰€æœ‰æ–°å¢å‚æ•°éƒ½æ˜¯å¯é€‰çš„
- ä¸æ”¹å˜ç°æœ‰è¿”å›å€¼ç»“æ„ï¼Œåªå¢åŠ  hint å­—æ®µ
- æ—¥å¿—æ ¼å¼å˜åŒ–æ˜¯å¢é‡çš„ï¼ˆå¢åŠ ç±»å‹æ ‡ç­¾å‰ç¼€ï¼‰

## äº”ã€å®æ–½è®¡åˆ’

### 5.1 é˜¶æ®µä¸€ï¼šlog_append typeï¼ˆP0ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `src/types/context.ts` - å¢åŠ  LogType ç±»å‹
2. `src/tools/log.ts` - æ›´æ–°å·¥å…·å®šä¹‰
3. `src/services/LogService.ts` - å®ç°ç±»å‹å¤„ç†å’Œ hint ç”Ÿæˆ

**æµ‹è¯•è¦ç‚¹**ï¼š
1. å„ç±»å‹æ—¥å¿—æ­£ç¡®è®°å½•
2. scheme_change ç±»å‹è¿”å›æ­£ç¡®çš„ hint
3. å…¼å®¹ä¸ä¼  type çš„æ—§è°ƒç”¨

### 5.2 é˜¶æ®µäºŒï¼šnode_transition schemeChangedï¼ˆP1ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `src/types/node.ts` - å¢åŠ  schemeChanged å‚æ•°
2. `src/tools/state.ts` - æ›´æ–°å·¥å…·å®šä¹‰
3. `src/services/StateService.ts` - å®ç°æ£€æŸ¥å’Œ hint

**æµ‹è¯•è¦ç‚¹**ï¼š
1. schemeChanged=true æ—¶è¿”å›æ­£ç¡®æé†’
2. ä¸å½±å“ç°æœ‰ complete æµç¨‹

### 5.3 é˜¶æ®µä¸‰ï¼šnode_update reasonï¼ˆP2ï¼Œå¯é€‰ï¼‰

**ä¿®æ”¹æ–‡ä»¶**ï¼š
1. `src/types/node.ts` - å¢åŠ  UpdateReason ç±»å‹
2. `src/tools/node.ts` - æ›´æ–°å·¥å…·å®šä¹‰
3. `src/services/NodeService.ts` - å®ç° hint

## å…­ã€æ•ˆæœé¢„æœŸ

### 6.1 æ–¹æ¡ˆå˜æ›´åœºæ™¯çš„æ–°æµç¨‹

```
ç”¨æˆ·åé¦ˆæ–¹æ¡ˆéœ€è¦è°ƒæ•´
    â†“
AI è°ƒç”¨ log_append({ type: "scheme_change", event: "æ ¹æ®ç”¨æˆ·åé¦ˆï¼Œæ”¹ç”¨ CommonCache" })
    â†“
ç³»ç»Ÿè¿”å›ï¼š
{
  success: true,
  hint: "âš ï¸ æ–¹æ¡ˆå˜æ›´å·²è®°å½•ã€‚è¯·åŠ¡å¿…ï¼š
    1. ä½¿ç”¨ node_update æ›´æ–°å½“å‰èŠ‚ç‚¹çš„ requirement
    2. æ£€æŸ¥çˆ¶èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹æ˜¯å¦éœ€è¦åŒæ­¥æ›´æ–°"
}
    â†“
AI çœ‹åˆ°æé†’ï¼Œè°ƒç”¨ node_update æ›´æ–° requirement
    â†“
AI æ£€æŸ¥å¹¶æ›´æ–°ç›¸å…³èŠ‚ç‚¹
    â†“
AI ç»§ç»­æ‰§è¡Œä»»åŠ¡
    â†“
AI è°ƒç”¨ node_transition({ action: "complete", schemeChanged: true, conclusion: "..." })
    â†“
ç³»ç»Ÿå†æ¬¡æé†’æ£€æŸ¥ï¼ˆåŒé‡ä¿éšœï¼‰
```

### 6.2 è¦†ç›–çš„åœºæ™¯

| åœºæ™¯ | è§¦å‘ç‚¹ | æé†’ |
|------|--------|------|
| ç”¨æˆ·åé¦ˆå¯¼è‡´æ–¹æ¡ˆå˜æ›´ | log_append type=scheme_change | æ›´æ–° requirement + ç›¸å…³èŠ‚ç‚¹ |
| AI è‡ªå·±å‘ç°éœ€è¦è°ƒæ•´æ–¹æ¡ˆ | log_append type=scheme_change | æ›´æ–° requirement + ç›¸å…³èŠ‚ç‚¹ |
| è°ƒç ”å‘ç°å½±å“æ–¹æ¡ˆ | log_append type=discovery | è€ƒè™‘æ˜¯å¦æ–¹æ¡ˆå˜æ›´ |
| åšå‡ºå…³é”®å†³ç­– | log_append type=decision | è€ƒè™‘æ›´æ–° requirement |
| å®Œæˆæ—¶ç¡®è®¤æ–¹æ¡ˆå˜æ›´ | node_transition schemeChanged=true | æ£€æŸ¥ requirement |

## ä¸ƒã€åç»­æ‰©å±•

### 7.1 æ—¥å¿—åˆ†æ

ç»“æ„åŒ–çš„æ—¥å¿—ç±»å‹å¯ä»¥ç”¨äºï¼š
- ç»Ÿè®¡æ–¹æ¡ˆå˜æ›´é¢‘ç‡
- åˆ†æä»»åŠ¡æ‰§è¡Œæ¨¡å¼
- ç”Ÿæˆä»»åŠ¡å¤ç›˜æŠ¥å‘Š

### 7.2 æ™ºèƒ½æ£€æµ‹

æœªæ¥å¯ä»¥ï¼š
- åˆ†æ conclusion å’Œ requirement çš„å·®å¼‚
- è‡ªåŠ¨æ£€æµ‹å¯èƒ½çš„æ–¹æ¡ˆå˜æ›´
- ä¸»åŠ¨æé†’ AI ç¡®è®¤

### 7.3 Web UI å±•ç¤º

æ—¥å¿—ç±»å‹å¯ä»¥åœ¨ Web UI ä¸­ï¼š
- ç”¨ä¸åŒé¢œè‰²/å›¾æ ‡åŒºåˆ†
- æ”¯æŒæŒ‰ç±»å‹ç­›é€‰
- é«˜äº®æ˜¾ç¤ºæ–¹æ¡ˆå˜æ›´

## å…«ã€ç‰ˆæœ¬

- v0.1 - 2025-12-18 - åˆå§‹è®¾è®¡
